{% extends "base.html" %}
{% block content %}

<div class="game-container">

    <!-- FLOATING SPADE 2 CARD -->
    <div class="floating-card">
        <img src="https://deckofcardsapi.com/static/img/2S.png"
     class="card-image glow-float"
     alt="Spades 2">

    </div>

    <div class="game-card-display">

        <h2 class="menu-title">ðŸ‚¢ Spades 2 â€“ Reaction Timer</h2>

        <p class="game-text">
            Click the correct box as soon as it says <b>NOW!</b><br>
            You must react within <span class="danger">0.35 seconds</span>.<br>
            Complete <b>3 rounds</b> to unlock the next card.
        </p>

        <div class="reaction-grid">
            <div id="box-left" class="reaction-box">WAITâ€¦</div>
            <div id="box-right" class="reaction-box">WAITâ€¦</div>
        </div>

        <p id="round-status" class="round-text">Round: 1 / 3</p>
        <p id="result" class="result-text"></p>

        <button id="start-btn" class="btn red-btn start-center">Start</button>

        <div class="next-nav">
            <a id="next-card"
               href="{{ url_for('main.suit_cards', suit='spades') }}"
               class="btn card-btn"
               style="display:none;">Next Card â†’</a>

            <a href="{{ url_for('main.suit_cards', suit='spades') }}"
               class="btn card-btn">Back</a>
        </div>

    </div>
</div>

<script>
const boxLeft = document.getElementById("box-left");
const boxRight = document.getElementById("box-right");
const resultText = document.getElementById("result");
const roundStatus = document.getElementById("round-status");
const startBtn = document.getElementById("start-btn");
const nextCardBtn = document.getElementById("next-card");

let canClick = false;
let startTime = 0;
let currentRound = 1;
let totalTime = 0;
let correctBox = null;
let failOffset = 0;

function resetBoxes() {
    boxLeft.textContent = "WAITâ€¦";
    boxRight.textContent = "WAITâ€¦";
    boxLeft.style.background = "#222";
    boxRight.style.background = "#222";
}

startBtn.onclick = () => {
    resultText.textContent = "";
    startBtn.style.display = "none";
    resetBoxes();

    const delay = Math.random() * 3000 + 1000;
    correctBox = Math.random() < 0.5 ? "left" : "right";

    setTimeout(() => {
        const box = correctBox === "left" ? boxLeft : boxRight;
        box.textContent = "NOW!";
        box.style.background = "#ff2222";

        startTime = performance.now();
        canClick = true;
    }, delay);
};

function handleClick(side) {
    if (!canClick) return;

    canClick = false;
    const reactionTime = performance.now() - startTime;

    if (side === correctBox && reactionTime <= 350) {
        resultText.textContent = `âœ” ${reactionTime.toFixed(0)} ms â€” Good!`;
        resultText.style.color = "#00ff66";
        totalTime += reactionTime;

        if (currentRound === 3) {
            resultText.textContent =
                `ðŸŽ‰ Completed! Total Time â‰ˆ ${Math.round(totalTime)} ms`;
            nextCardBtn.style.display = "inline-block";
            fetch("/complete/spades/2", { method: "POST" });
        } else {
            currentRound++;
            roundStatus.textContent = `Round: ${currentRound} / 3`;
            startBtn.style.display = "block";
        }
    } else {
        resultText.textContent = "âŒ Too slow! Try again.";
        resultText.style.color = "#ff4444";

        // punishment: move start button left
        failOffset -= 20;
        startBtn.style.transform = `translateX(${failOffset}px)`;
        startBtn.style.display = "block";
    }
}

boxLeft.onclick = () => handleClick("left");
boxRight.onclick = () => handleClick("right");
</script>

<style>

/* GAME UI */
.reaction-grid {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 20px;
}

.reaction-box {
    width: 180px;
    height: 150px;
    background: #222;
    border: 3px solid red;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.round-text {
    margin-top: 18px;
    font-size: 20px;
    font-weight: bold;
}

.result-text {
    margin-top: 15px;
    font-size: 22px;
}

.start-center {
    display: block;
    margin: 20px auto;
    transition: transform 0.3s ease;
}

.danger {
    color: #ff4444;
    font-weight: bold;
}
</style>

{% endblock %}

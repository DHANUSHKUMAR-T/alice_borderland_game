{% extends "base.html" %}
{% block content %}

<div class="game-container">

    <div class="game-card-display">

        <h2 class="menu-title">ðŸ‚¡ Diamonds A â€“ Value Sort</h2>

        <p class="game-text">
            Items appear in random order.<br>
            ðŸ‘‰ Arrange from <b>MOST valuable â†’ LEAST valuable for situational and survival</b>.
        </p>

        <div class="emotion-hint">
            ðŸ’Ž Value depends on need, not price<br>
            ðŸ§  Context beats cost
        </div>

        <!-- START -->
        <button id="start-btn" class="btn red-btn">Start Sorting</button>

        <!-- GAME AREA -->
        <div id="game-area" style="display:none;">

            <p id="timer" class="timer-text">Time Left: 20s</p>
            <p id="round-info" class="round-text">Round 1 / 3</p>

            <!-- ITEMS -->
            <div id="items" class="item-box"></div>

            <p id="result" class="result-text"></p>

            <!-- NAV -->
            <div class="button-row">
                <a id="next-btn"
                   href="{{ url_for('main.suit_cards', suit='diamonds') }}"
                   class="btn card-btn"
                   style="display:none;">
                   Next Card â†’
                </a>

                <a href="{{ url_for('main.suit_cards', suit='diamonds') }}"
                   class="btn card-btn">
                   Back
                </a>
            </div>

        </div>

    </div>

    <!-- FLOATING DIAMONDS A CARD -->
    <div class="floating-card">
        <img src="https://deckofcardsapi.com/static/img/AD.png"
             class="card-image glow-float"
             alt="Diamonds A">
    </div>

</div>

<script>
/* ===============================
   VALUE SCENARIOS
================================ */
const scenarios = [
    {
        items: ["Water bottle", "Gold ring", "Phone", "Book"],
        correct: ["Water bottle", "Phone", "Book","Gold ring"]
    },
    {
        items: ["Passport", "Cash", "Luxury watch", "Food packet"],
        correct: ["Food packet", "Passport", "Cash", "Luxury watch"]
    },
    {
        items: ["First aid kit", "Diamond necklace", "Camera", "Diary"],
        correct: ["First aid kit", "Camera", "Diary","Diamond necklace"]
    },
    {
        items: ["Charging cable", "Smartphone", "Cash", "Perfume"],
        correct: [ "Smartphone","Charging cable", "Cash", "Perfume"]
    },
    {
        items: ["Food can", "Gold bar", "Knife", "Headphones"],
        correct: ["Food can", "Knife", "Gold bar", "Headphones"]
    },
    {
        items: ["Blanket", "Luxury bag", "Wallet", "Sunglasses"],
        correct: ["Blanket", "Wallet",  "Sunglasses","Luxury bag"]
    },
    {
        items: ["Medicine", "Watch", "Laptop With Internet", "Notebook"],
        correct: ["Medicine", "Laptop With Internet", "Watch", "Notebook"]
    },
    {
        items: ["Shoes", "Water purifier tablet", "Cash", "Ring"],
        correct: ["Water purifier tablet", "Shoes", "Cash", "Ring"]
    },
    {
        items: ["Power bank", "Tablet", "Gold chain", "Magazine"],
        correct: ["Power bank", "Tablet", "Gold chain", "Magazine"]
    },
    {
        items: ["Raincoat", "Designer shoes", "Phone", "Bracelet"],
        correct: ["Raincoat", "Phone","Bracelet", "Designer shoes"]
    },
    {
        items: ["Torch", "Map", "Gold coin", "Notebook"],
        correct: ["Torch", "Map", "Gold coin", "Notebook"]
    }
];

/* ===============================
   ELEMENTS
================================ */
const startBtn = document.getElementById("start-btn");
const gameArea = document.getElementById("game-area");
const itemsBox = document.getElementById("items");
const timerEl = document.getElementById("timer");
const resultEl = document.getElementById("result");
const roundInfo = document.getElementById("round-info");
const nextBtn = document.getElementById("next-btn");

/* ===============================
   STATE
================================ */
let round = 1;
let timer = 20;
let interval = null;
let currentScenario = null;
let userOrder = [];
const TOTAL_ROUNDS = 3;

/* ===============================
   START GAME
================================ */
startBtn.onclick = () => {
    startBtn.style.display = "none";
    gameArea.style.display = "block";
    round = 1;
    startRound();
};

/* ===============================
   START ROUND
================================ */
function startRound() {
    clearInterval(interval);
    resultEl.textContent = "";
    itemsBox.innerHTML = "";
    userOrder = [];

    roundInfo.textContent = `Round ${round} / ${TOTAL_ROUNDS}`;

    currentScenario = scenarios[Math.floor(Math.random() * scenarios.length)];

    // Shuffle items
    const shuffled = [...currentScenario.items].sort(() => Math.random() - 0.5);

    shuffled.forEach(item => {
        const btn = document.createElement("button");
        btn.className = "item-btn";
        btn.textContent = item;
        btn.onclick = () => selectItem(item, btn);
        itemsBox.appendChild(btn);
    });

    startTimer();
}

/* ===============================
   TIMER
================================ */
function startTimer() {
    timer = 20;
    timerEl.textContent = `Time Left: ${timer}s`;

    interval = setInterval(() => {
        timer--;
        timerEl.textContent = `Time Left: ${timer}s`;

        if (timer <= 0) {
            clearInterval(interval);
            evaluate();
        }
    }, 1000);
}

/* ===============================
   SELECT ITEM
================================ */
function selectItem(item, btn) {
    if (userOrder.includes(item)) return;

    userOrder.push(item);
    btn.classList.add("selected");

    if (userOrder.length === currentScenario.items.length) {
        clearInterval(interval);
        evaluate();
    }
}

/* ===============================
   EVALUATE
================================ */
function evaluate() {
    if (JSON.stringify(userOrder) === JSON.stringify(currentScenario.correct)) {
        passRound();
    } else {
        failRound("ðŸ’­ Value is about need, not cost.");
    }
}

/* ===============================
   PASS ROUND
================================ */
function passRound() {
    if (round < TOTAL_ROUNDS) {
        resultEl.textContent = "ðŸ’Ž Sharp judgment. You valued wisely.";
        resultEl.style.color = "#00ff66";

        setTimeout(() => {
            round++;
            startRound();
        }, 1300);
    } else {
        finishGame();
    }
}

/* ===============================
   FINAL SUCCESS
================================ */
function finishGame() {
    resultEl.textContent =
        "ðŸ’Ž You understand value beyond price. True Diamond thinking.";
    resultEl.style.color = "#00ff66";

    nextBtn.style.display = "inline-block";
    fetch("/complete/diamonds/A", { method: "POST" });
}

/* ===============================
   FAIL
================================ */
function failRound(msg) {
    resultEl.textContent = msg;
    resultEl.style.color = "#ffcccc";

    setTimeout(startRound, 1400);
}
</script>

<style>
.item-box {
    display: flex;
    flex-direction: column;
    gap: 14px;
    margin-top: 20px;
}

.item-btn {
    padding: 16px;
    font-size: 18px;
    font-weight: bold;
    background: rgba(0,0,0,0.6);
    color: #ffecec;
    border: 2px solid #ff4d6d;
    border-radius: 12px;
    cursor: pointer;
    transition: 0.2s;
}

.item-btn:hover {
    background: #ff4d6d;
    color: black;
}

.item-btn.selected {
    opacity: 0.5;
    pointer-events: none;
}

.timer-text, .round-text {
    font-size: 22px;
    color: #ffcccc;
}

.emotion-hint {
    font-size: 16px;
    color: #ffcccc;
    margin-bottom: 10px;
    opacity: 0.85;
}

.button-row {
    margin-top: 30px;
    display: flex;
    justify-content: center;
    gap: 25px;
}
</style>

{% endblock %}

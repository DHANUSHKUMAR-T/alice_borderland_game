{% extends "base.html" %}
{% block content %}

<div class="game-container">

    <div class="game-card-display">

        <h2 class="menu-title">üÇµ Hearts 5 ‚Äì Focus Under Emotion</h2>

        <p class="game-text">
            Emotions will appear everywhere.<br>
            üëâ Select only the <b>HAPPY hearts (‚ù§Ô∏èüôÇ)</b>.
        </p>

        <div class="emotion-hint">
            ‚ù§Ô∏è Focus, not reaction<br>
            üß† Calm beats impulse
        </div>

        <!-- START -->
        <button id="start-btn" class="btn red-btn">Start Focus</button>

        <!-- GAME AREA -->
        <div id="game-area" style="display:none;">

            <p id="timer" class="timer-text">Time Left: 6s</p>
            <p id="round-info" class="round-text">Round 1 / 3</p>

            <!-- PLAY AREA -->
            <div id="play-area" class="play-area"></div>

            <p id="result" class="result-text"></p>

            <!-- NAV -->
            <div class="button-row">
                <a id="next-btn"
                   href="{{ url_for('main.suit_cards', suit='hearts') }}"
                   class="btn card-btn"
                   style="display:none;">
                   Next Card ‚Üí
                </a>

                <a href="{{ url_for('main.suit_cards', suit='hearts') }}"
                   class="btn card-btn">
                   Back
                </a>
            </div>

        </div>

    </div>

    <!-- FLOATING HEART CARD (NON-CLICKABLE) -->
    <div class="floating-card">
        <img src="https://deckofcardsapi.com/static/img/5H.png"
             class="card-image glow-float"
             alt="Hearts 5">
    </div>

</div>

<script>
/* ===============================
   HEART DATA
================================ */
const heartTypes = [
    { emoji: "‚ù§Ô∏èüôÇ", happy: true },
    { emoji: "‚ù§Ô∏èüò¢", happy: false },
    { emoji: "‚ù§Ô∏èüò°", happy: false },
    { emoji: "üíîüòû", happy: false },
    { emoji: "üíîüò°", happy: false }
];

/* ===============================
   ELEMENTS
================================ */
const startBtn  = document.getElementById("start-btn");
const gameArea = document.getElementById("game-area");
const playArea = document.getElementById("play-area");
const timerEl  = document.getElementById("timer");
const resultEl = document.getElementById("result");
const nextBtn  = document.getElementById("next-btn");
const roundInfo = document.getElementById("round-info");

/* ===============================
   STATE
================================ */
let timer = 6;
let interval = null;
let spawnTimeout = null;
let active = false;
let round = 1;
let happyClicks = 0;
const TOTAL_ROUNDS = 3;

/* ===============================
   START GAME
================================ */
startBtn.addEventListener("click", () => {
    startBtn.style.display = "none";
    gameArea.style.display = "block";
    round = 1;
    startRound();
});

/* ===============================
   START ROUND
================================ */
function startRound() {
    clearInterval(interval);
    clearTimeout(spawnTimeout);

    playArea.innerHTML = "";
    resultEl.textContent = "";
    active = true;
    happyClicks = 0;

    roundInfo.textContent = `Round ${round} / ${TOTAL_ROUNDS}`;
    startTimer();
    spawnHearts();
}

/* ===============================
   TIMER
================================ */
function startTimer() {
    timer = 6;
    timerEl.textContent = `Time Left: ${timer}s`;

    interval = setInterval(() => {
        timer--;
        timerEl.textContent = `Time Left: ${timer}s`;

        if (timer <= 0) {
            clearInterval(interval);
            finishRound();
        }
    }, 1000);
}

/* ===============================
   SPAWN HEARTS (MOBILE SAFE)
================================ */
function spawnHearts() {
    if (!active) return;

    const heart = heartTypes[Math.floor(Math.random() * heartTypes.length)];
    const el = document.createElement("div");

    el.className = "floating-heart";
    el.textContent = heart.emoji;
    el.style.left = Math.random() * 80 + "%";
    el.style.animationDuration = (3 + Math.random() * 2) + "s";

    const handleTap = (e) => {
        e.stopPropagation();
        if (!active) return;

        if (heart.happy) {
            happyClicks++;
            el.remove();
        } else {
            failRound("üí≠ Not every emotion needs action.");
        }
    };

    el.addEventListener("click", handleTap);
    el.addEventListener("touchstart", handleTap, { passive: true });

    playArea.appendChild(el);

    setTimeout(() => el.remove(), 5000);
    spawnTimeout = setTimeout(spawnHearts, 600);
}

/* ===============================
   ROUND COMPLETE
================================ */
function finishRound() {
    active = false;
    clearTimeout(spawnTimeout);

    if (happyClicks === 0) {
        failRound("üß† Focus means acting at the right moment.");
        return;
    }

    if (round < TOTAL_ROUNDS) {
        resultEl.textContent = "‚ù§Ô∏è Good focus. Stay calm.";
        resultEl.style.color = "#ffcccc";

        setTimeout(() => {
            round++;
            startRound();
        }, 1200);
    } else {
        finishGame();
    }
}

/* ===============================
   FINAL SUCCESS
================================ */
function finishGame() {
    active = false;
    clearTimeout(spawnTimeout);

    resultEl.textContent =
        "‚ù§Ô∏è You stayed focused even when emotions surrounded you.";
    resultEl.style.color = "#00ff66";

    nextBtn.style.display = "inline-block";
    fetch("/complete/hearts/5", { method: "POST" });
}

/* ===============================
   FAIL (RESTART ROUND)
================================ */
function failRound(msg) {
    active = false;
    clearInterval(interval);
    clearTimeout(spawnTimeout);

    resultEl.textContent = msg;
    resultEl.style.color = "#ffcccc";

    setTimeout(startRound, 1400);
}
</script>

<style>
/* GENERAL MOBILE SAFETY */
* {
    -webkit-tap-highlight-color: transparent;
}

/* PLAY AREA */
.play-area {
    position: relative;
    height: 300px;
    margin-top: 20px;
    overflow: hidden;
}

/* FLOATING HEARTS */
.floating-heart {
    position: absolute;
    bottom: -40px;
    font-size: 34px;
    cursor: pointer;
    animation: floatUp linear forwards;
    z-index: 9999;
    pointer-events: auto;
    touch-action: manipulation;
}

/* FLOAT ANIMATION */
@keyframes floatUp {
    from { transform: translateY(0); opacity: 1; }
    to   { transform: translateY(-350px); opacity: 0; }
}

/* DISABLE TOUCH ON CARD IMAGE */
.floating-card {
    pointer-events: none;
}

/* TEXT */
.timer-text, .round-text {
    font-size: 22px;
    color: #ffcccc;
}

.emotion-hint {
    font-size: 16px;
    color: #ffcccc;
    margin-bottom: 10px;
    opacity: 0.85;
}

.button-row {
    margin-top: 30px;
    display: flex;
    justify-content: center;
    gap: 25px;
}
</style>

{% endblock %}

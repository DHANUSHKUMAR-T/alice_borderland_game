{% extends "base.html" %}
{% block content %}

<div class="game-container">

  <!-- FLOATING CARD -->
  <div class="floating-card">
    <img src="https://deckofcardsapi.com/static/img/2S.png"
         class="card-image glow-float"
         alt="Spades 2">
  </div>

  <div class="game-card-display">

    <h2 class="menu-title">ðŸ‚¢ Spades 2 â€“ Reaction Timer</h2>

    <p class="game-text">
      Click the correct box as soon as it says <b>NOW!</b><br>
      React within <span class="danger" id="limit-text"></span>.<br>
      Complete <b>3 rounds</b> to unlock the next card.
    </p>

    <div class="reaction-grid">
      <div id="box-left" class="reaction-box">WAITâ€¦</div>
      <div id="box-right" class="reaction-box">WAITâ€¦</div>
    </div>

    <p id="round-status" class="round-text">Round: 1 / 3</p>
    <p id="result" class="result-text"></p>

    <button id="start-btn" class="btn red-btn start-center">Start</button>

    <div class="next-nav">
      <a id="next-card"
         href="{{ url_for('main.suit_cards', suit='spades') }}"
         class="btn card-btn"
         style="display:none;">
        Next Card â†’
      </a>

      <a href="{{ url_for('main.suit_cards', suit='spades') }}"
         class="btn card-btn">Back</a>
    </div>

  </div>
</div>

<script>
/* ===============================
   DEVICE DETECTION
================================ */
const isTouch =
  'ontouchstart' in window ||
  navigator.maxTouchPoints > 0;

/* ===============================
   THRESHOLD (FAIR PLAY)
================================ */
const REACTION_LIMIT = isTouch ? 950 : 800;
document.getElementById("limit-text").textContent =
  `${REACTION_LIMIT} ms`;

/* ===============================
   ELEMENTS
================================ */
const boxLeft = document.getElementById("box-left");
const boxRight = document.getElementById("box-right");
const resultText = document.getElementById("result");
const roundStatus = document.getElementById("round-status");
const startBtn = document.getElementById("start-btn");
const nextCardBtn = document.getElementById("next-card");

/* ===============================
   STATE
================================ */
let canClick = false;
let startTime = 0;
let currentRound = 1;
let totalTime = 0;
let correctBox = null;
let failOffset = 0;

/* ===============================
   RESET
================================ */
function resetBoxes() {
  boxLeft.textContent = "WAITâ€¦";
  boxRight.textContent = "WAITâ€¦";
  boxLeft.style.background = "#222";
  boxRight.style.background = "#222";
}

/* ===============================
   START ROUND
================================ */
startBtn.onclick = () => {
  resultText.textContent = "";
  startBtn.style.display = "none";
  resetBoxes();

  const delay = Math.random() * 2500 + 1200;
  correctBox = Math.random() < 0.5 ? "left" : "right";

  setTimeout(() => {
    const box = correctBox === "left" ? boxLeft : boxRight;
    box.textContent = "NOW!";
    box.style.background = "#ff2222";

    startTime = performance.now();
    canClick = true;
  }, delay);
};

/* ===============================
   CLICK HANDLER
================================ */
function handleClick(side) {
  if (!canClick) return;

  canClick = false;
  const reactionTime = performance.now() - startTime;

  if (side === correctBox && reactionTime <= REACTION_LIMIT) {
    resultText.textContent =
      `âœ” ${Math.round(reactionTime)} ms â€” Controlled reaction`;
    resultText.style.color = "#00ff66";

    totalTime += reactionTime;

    if (currentRound === 3) {
      resultText.textContent =
        `ðŸŽ‰ Completed! Avg â‰ˆ ${Math.round(totalTime)} ms`;
      nextCardBtn.style.display = "inline-block";
      fetch("/complete/spades/2", { method: "POST" });
    } else {
      currentRound++;
      roundStatus.textContent = `Round: ${currentRound} / 3`;
      startBtn.style.display = "block";
    }
  } else {
    resultText.textContent = "âŒ Timing slipped. Try again.";
    resultText.style.color = "#ff4444";

    startBtn.style.display = "block";
  }
}

boxLeft.onclick = () => handleClick("left");
boxRight.onclick = () => handleClick("right");
</script>

<style>
.reaction-grid {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin-top: 20px;
}

.reaction-box {
  width: 180px;
  height: 150px;
  background: #222;
  border: 3px solid red;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
}

.round-text {
  margin-top: 18px;
  font-size: 20px;
  font-weight: bold;
}

.result-text {
  margin-top: 15px;
  font-size: 22px;
  min-height: 28px;
}

.start-center {
  display: block;
  margin: 20px auto;
  transition: transform 0.3s ease;
}

.danger {
  color: #ff4444;
  font-weight: bold;
}
</style>

{% endblock %}

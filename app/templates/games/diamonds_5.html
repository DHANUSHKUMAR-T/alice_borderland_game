{% extends "base.html" %}
{% block content %}

<div class="game-container">
  <div class="game-card-display">

    <h2 class="menu-title">üÇ• Diamonds 5 ‚Äì Silence Test</h2>

    <p class="game-text">
      Control your environment.<br>
      üëâ Maintain calm, controlled silence.
    </p>

    <div class="emotion-hint">
      üéôÔ∏è Discipline > reaction<br>
      üíé Control > effort
    </div>

    <!-- DEVICE NOTE -->
    <div class="device-note">
      ‚ö†Ô∏è <b>Best Experience:</b> This challenge works most accurately on
      <b>mobile phones or tablets</b>.<br>
      Laptop microphones often auto-reduce sensitivity.
    </div>

    <button id="start-btn" class="btn red-btn">Allow Microphone</button>

    <div id="game-area" style="display:none;">
      <p id="timer" class="timer-text">Time Left: 15s</p>

      <p id="instruction" class="situation-text">
        üîá Stay silent. Control your space.
      </p>

      <p class="rule-text">
        ‚ö†Ô∏è If sound reaches <b>10%</b>, control breaks.
      </p>

      <!-- SOUND METER -->
      <div class="meter">
        <div class="meter-mark left">0%</div>
        <div class="meter-mark mid">10%</div>
        <div class="meter-mark right">100%</div>

        <div class="fail-line"></div>
        <div id="meter-fill"></div>
      </div>

      <p id="result" class="result-text"></p>

      <div class="button-row">
        <a id="next-btn"
           href="{{ url_for('main.suit_cards', suit='diamonds') }}"
           class="btn card-btn"
           style="display:none;">
          Next Card ‚Üí
        </a>

        <a href="{{ url_for('main.suit_cards', suit='diamonds') }}"
           class="btn card-btn">
          Back
        </a>
      </div>
    </div>
  </div>

  <div class="floating-card">
    <img src="https://deckofcardsapi.com/static/img/5D.png"
         class="card-image glow-float"
         alt="Diamonds 5">
  </div>
</div>

<script>
/* ===============================
   AUDIO STATE
================================ */
let audioContext, analyser, mic;
let timer = 15;
let interval = null;
let active = false;

/* ELEMENTS */
const startBtn = document.getElementById("start-btn");
const gameArea = document.getElementById("game-area");
const timerEl = document.getElementById("timer");
const resultEl = document.getElementById("result");
const meterFill = document.getElementById("meter-fill");
const nextBtn = document.getElementById("next-btn");

/* START GAME */
startBtn.onclick = async () => {
  try {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

    mic = audioContext.createMediaStreamSource(stream);
    analyser = audioContext.createAnalyser();
    analyser.fftSize = 1024;
    mic.connect(analyser);

    startBtn.style.display = "none";
    gameArea.style.display = "block";
    active = true;

    startTimer();
    monitorSound();
  } catch {
    alert("Microphone permission required.");
  }
};

/* TIMER */
function startTimer() {
  interval = setInterval(() => {
    timer--;
    timerEl.textContent = `Time Left: ${timer}s`;

    if (timer <= 0) {
      clearInterval(interval);
      finishGame();
    }
  }, 1000);
}

/* SOUND MONITOR (0‚Äì100%) */
function monitorSound() {
  const data = new Uint8Array(analyser.fftSize);

  function loop() {
    if (!active) return;

    analyser.getByteTimeDomainData(data);

    let sum = 0;
    for (let i = 0; i < data.length; i++) {
      const v = (data[i] - 128) / 128;
      sum += v * v;
    }

    const rms = Math.sqrt(sum / data.length);

    /* Gentle scaling for 10% threshold */
    const percent = Math.min(Math.round(rms * 110), 100);

    meterFill.style.width = percent + "%";

    if (percent < 10) {
      meterFill.style.background = "#00ff66";
    } else {
      meterFill.style.background = "#ff4444";
    }

    if (percent >= 10) {
      fail("‚ùå Sound exceeded control limit.");
      return;
    }

    requestAnimationFrame(loop);
  }

  loop();
}

/* FAIL */
function fail(msg) {
  active = false;
  clearInterval(interval);
  resultEl.textContent = msg;
  resultEl.style.color = "#ff4444";
}

/* SUCCESS */
function finishGame() {
  active = false;
  resultEl.textContent = "‚úî Silence maintained. Control achieved.";
  resultEl.style.color = "#00ff66";
  nextBtn.style.display = "inline-block";
  fetch("/complete/diamonds/5", { method: "POST" });
}
</script>

<style>
.device-note {
  background: rgba(255, 0, 0, 0.08);
  border: 1px solid #ff4444;
  padding: 10px;
  border-radius: 10px;
  font-size: 13px;
  margin-bottom: 14px;
  color: #ffcccc;
}

.rule-text {
  font-size: 14px;
  color: #ffcccc;
}

.meter {
  position: relative;
  width: 260px;
  height: 16px;
  background: #222;
  border-radius: 10px;
  margin: 20px auto;
}

#meter-fill {
  height: 100%;
  width: 0%;
  border-radius: 10px;
  transition: width 0.08s linear;
}

.fail-line {
  position: absolute;
  left: 10%;
  top: 0;
  height: 100%;
  width: 2px;
  background: #ff4444;
}

.meter-mark {
  position: absolute;
  top: 20px;
  font-size: 11px;
  color: #ccc;
}

.meter-mark.left { left: 0; }
.meter-mark.mid { left: 10%; transform: translateX(-50%); color: #ff4444; }
.meter-mark.right { right: 0; }

.timer-text {
  font-size: 22px;
  color: #ffcccc;
}
</style>

{% endblock %}
